(function($,window,document,undefined){var FBC_console="fbc_console",data_plugin="plugin_"+FBC_console,defaults={app_id:'',user_info:{user_id:null,user_name:null,user_email:null,gravatar:null,user_type:null,avatar_type:null,avatar_image:null,current_page:null,user_ip:null}},premium={show_chat_timer:function(cnv){var self=this;self.data.ref_cnv.child(cnv).once('value',function(snapshot){if(snapshot.val()!==null){var cnv_obj=snapshot.val();if(cnv_obj.accepted_at==''){self.data.ref_cnv.child(cnv).child('accepted_at').set(Firebase.ServerValue.TIMESTAMP,function(){self.data.ref_cnv.child(cnv).once('value',function(snapshot){if(snapshot.val()!==null){var cnv_obj=snapshot.val();self.trigger_premium('set_timer',cnv_obj.accepted_at)}})})}else{self.trigger_premium('set_timer',cnv_obj.accepted_at)}}})},premium_console:function(){var self=this;$('.macro-select').select2({placeholder:self.strings.msg.macro_title,allowClear:!0});$('.macro-select').on('change',function(e){var value=$(this).val();if(value!=''&&value!=null){var textarea=$('#FBC_cnv_reply'),text=textarea.val();textarea.val(text+value);$(this).select2('val','');textarea.trigger('autosize.resize').focus()}});var sound_set=['connected','disconnected','online','offline','new-msg'];for(i=0;i<sound_set.length;++i){var source=document.createElement('source'),name=sound_set[i],filename=fbc.plugin_url+'/sounds/'+name;self.sounds[name]=document.createElement('audio');if(self.sounds[name].canPlayType('audio/mpeg;')){source.type='audio/mpeg';source.src=filename+'.mp3'}else{source.type='audio/ogg';source.src=filename+'.ogg'}
self.sounds[name].appendChild(source)}},set_timer:function(start){var self=this;self.objs.list_interval=setInterval(function(){var now=new Date(),time=self.trigger_premium('chat_duration',start,now.getTime());$('#FBC_timer').html(time);if($('#FBC_cnv_reply').is(':disabled')){clearInterval(self.objs.list_interval)}},1000)},end_chat_console:function(cnv_id,delete_from_app,end_chat,btn,ntf){var self=this;this.trigger_premium('save_user_data',cnv_id,delete_from_app,end_chat,delete_from_app,function(r){self.objs.working=!1;btn.removeClass('button-disabled');if(r.error)
ntf.html(r.error);else ntf.html(r.msg);setTimeout(function(){ntf.fadeOut(2000);ntf.html()},1000);if(delete_from_app){setTimeout(function(){self.show_welcome_popup()},3000)}})},play_sound:function(sound_name){},chat_duration:function(start_time,now_time){if(now_time==''||start_time==''){return'00:00:00'}
var seconds=((now_time-start_time)*0.001)>>0,minutes=seconds/60>>0,hours=minutes/60>>0;hours=hours%60;minutes=minutes%60;seconds=seconds%60;hours=(hours<10)?'0'+hours:hours;minutes=(minutes<10)?'0'+minutes:minutes;seconds=(seconds<10)?'0'+seconds:seconds;return hours+':'+minutes+':'+seconds},save_user_data:function(cnv_id,delete_from_app,end_chat,send_email,callback){var self=this,r=null;this.data.ref_cnv.child(cnv_id).once('value',function(snap_cnv){var exists=(snap_cnv.val()!==null),cnv=snap_cnv.val();if(!exists){if(callback){callback({})}
return}
var user_id=cnv.user_id,duration=self.trigger_premium('chat_duration',cnv.accepted_at,end_chat);self.data.ref_users.child(user_id).once('value',function(snap_user){var user_data=snap_user.val();user_data.created_at=cnv.created_at;user_data.evaluation=cnv.evaluation;user_data.duration=duration;user_data.receive_copy=cnv.receive_copy;user_data.send_email=send_email;self.data.ref_msgs.once('value',function(snap_msgs){var msgs=snap_msgs.val(),total_msgs=msgs?Object.keys(msgs).length:0,i=0,msgs_data={};if(msgs){$.each(msgs,function(msg_id,msg){i=i+1;if(msg.conversation_id===cnv_id){msgs_data[msg_id]=msg;if(delete_from_app)
self.data.ref_msgs.child(msg_id).remove()}
if(total_msgs===i){user_data.msgs=msgs_data;self.post('fbc_ajax_callback','save_chat',user_data,function(r){if(callback)
callback(r)})}})}else if(callback){callback({})}
if(delete_from_app){self.data.ref_users.child(user_id).remove();self.data.ref_cnv.child(cnv_id).remove()}})})})},set_avatar_premium:function(user_type,user_data){if(user_type!='admin')
return'https://www.gravatar.com/avatar/'+user_data.gravatar+'.jpg?s=60&d='+fbc.default_user_avatar;switch(user_data.avatar_type){case 'gravatar':return'https://www.gravatar.com/avatar/'+user_data.gravatar+'.jpg?s=60&d='+fbc.default_admin_avatar;break;case 'image':return user_data.avatar_image;break;default:if(fbc.company_avatar!=''){return fbc.company_avatar}else{return this.data.assets_url+'/images/default-avatar-'+user_type+'.png'}}},};function Plugin(){this.opts=$.extend(defaults,fbc.defaults);this.premium=$.extend({},premium)}
Plugin.prototype={init:function(){this.data={auth:null,ref:null,is_mobile:!1,active_user_id:0,mode:"offline",logged:!1,assets_url:fbc.plugin_url,user:{},online_ops:{}};this.strings=fbc.strings;this.sounds={};this.objs={last_cnv_id:null,last_user_id:null,last_msg_id:null,right_sidebar_html:'',list_interval:null,working:!1,checked_user_ids:[],new_msgs_count:{}};var self=this;$('#FBC_connect').click(function(e){e.preventDefault();$('#FBC_notify').show().html(self.strings.msg.connecting+'...');if(!$(this).data('logged')){self.login(!0)}else if($(this).data('status','online')){self.be_offline()}});if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){this.data.is_mobile=!0}
this.post('fbc_ajax_callback','get_token',{},function(r){if(!r.error){self.data.auth_token=r.token;self.check_ntf();self.auth()}})},auth:function(callback){if(!this.opts.app_id){console.error('App ID not provided');return}
if(this.data.ref==null){this.data.ref=new Firebase('https://'+this.opts.app_id+'.firebaseIO.com');this.data.ref_conn=new Firebase('https://'+this.opts.app_id+'.firebaseIO.com/.info/connected');this.data.ref_cnv=new Firebase('https://'+this.opts.app_id+'.firebaseIO.com/chat_sessions');this.data.ref_msgs=new Firebase('https://'+this.opts.app_id+'.firebaseIO.com/chat_messages');this.data.ref_users=new Firebase('https://'+this.opts.app_id+'.firebaseIO.com/chat_users')}
this.login(!1,callback);this.after_load()},after_load:function(){var self=this;$(document).on('keydown','#FBC_cnv_reply',function(){$(this).trigger('autosize.resize');$(window).trigger('resize')});$(document).on('focus','#FBC_cnv_reply',function(){$(this).autosize({append:''})});$(document).on('click','#FBC_users li.free, #FBC_users li.busy',function(){var obj_user=$(this);if(self.objs.list_interval!=null)
clearInterval(self.objs.list_interval);self.get_user_data($(this).data('id'),function(user){if(self.data.active_user_id)
$('#FBC_chat_user_'+self.data.active_user_id).removeClass('chat-active');obj_user.addClass('chat-active').removeClass('new-msg').data('count',0).find('.chat-count').empty();$('#FBC_popup_cnv').removeClass('chat-welcome');$('#FBC_cnv_reply').val('').focus().removeAttr('disabled');$('.chat-cnv-input').removeClass('chat-disabled');$('.sidebar-info.info-name span').html(user.user_name);$('.sidebar-info.info-ip span').html(user.user_ip);$('.sidebar-info.info-email a').html(user.user_email).attr('href','mailto:'+user.user_email);$('.sidebar-info.info-page a').html(((user.current_page)?user.current_page:'N/A')).attr('href',((user.current_page)?user.current_page:'#'));$('#FBC_end_chat').attr('data-cnv-id',obj_user.data('cnv-id'));$('#FBC_save').attr('data-cnv-id',obj_user.data('cnv-id'));$('#FBC_active_cnv').val(obj_user.data('cnv-id'));self.objs.cnv=$('#FBC_cnv');self.objs.cnv.html('');self.data.user.conversation_id=obj_user.data('cnv-id');self.data.active_user_id=obj_user.data('id');self.reload_cnv(obj_user.data('cnv-id'));self.manage_reply_box(self.objs.last_cnv_id);self.objs.last_cnv_id=obj_user.data('cnv-id');self.objs.cnv.show();$('#FBC_cnv_bottom .user-avatar img').attr('src',self.set_avatar(self.data.user.user_type,{gravatar:self.data.user.gravatar,avatar_type:self.data.user.avatar_type,avatar_image:self.data.user.avatar_image}));$('#FBC_cnv_bottom').show();$('#FBC_sidebar_right').show();if(obj_user.data('chat')=='free'){self.data.ref_users.child(obj_user.data('id')).child('chat_with').set(self.data.user.user_id)}else{if(obj_user.data('chat')==self.data.user.user_id){$('#FBC_end_chat').show()}else{$('#FBC_end_chat').hide()}}
self.trigger_premium('show_chat_timer',obj_user.data('cnv-id'));$(window).trigger('resize')})});$(document).on('click','#FBC_save, #FBC_end_chat',function(e){var btn=$(this),ntf=$('#FBC_save_ntf'),delete_from_app=($(this).attr('id')==='FBC_end_chat'),now=new Date(),end_chat=now.getTime();ntf.show();if(self.objs.working){ntf.html(self.strings.msg.please_wait+'...');return}
self.objs.working=!0;$(this).addClass('button-disabled');ntf.html(self.strings.msg.saving+'...');if(delete_from_app){if(self.objs.list_interval!=null)
clearInterval(self.objs.list_interval)}
if(fbc.is_premium){self.trigger_premium('end_chat_console',$('#FBC_active_cnv').val(),delete_from_app,end_chat,btn,ntf)}else{self.clear_user_data($('#FBC_active_cnv').val(),function(){self.objs.working=!1;btn.removeClass('button-disabled');setTimeout(function(){ntf.fadeOut(500)},100);setTimeout(function(){self.show_welcome_popup()},1000)})}});this.trigger_premium('premium_console');$('#FBC_popup_cnv').mouseover(function(){$('#FBC_chat_user_'+self.data.active_user_id).removeClass('new-msg').data('count',0).find('.chat-count').empty()});setInterval(function(){$('.chat-last-online').each(function(i){$(this).html(self.timeago($(this).data('time')))})},60000);var wait=0;setInterval(function(){var new_wait=0;self.data.ref_users.once('value',function(snap){var users=snap.val();if(users!==null){$.each(users,function(user_id,user){if(user){if(user.status==='wait'){new_wait=new_wait+1}}})}});wait=new_wait;if(new_wait>0){$('#FBC_queue').html(self.strings.msg.waiting_users.replace(/%d/i,new_wait)).show()}else{$('#FBC_queue').hide()}},15000);window.onbeforeunload=function(e){var ev=e||window.event;if(ev){ev.returnValue=self.strings.msg.ntf_close_console}
return self.strings.msg.ntf_close_console}},login:function(new_user,callback){var self=this;this.manage_connections();this.data._new_user=new_user;this.data.auth=this.data.ref.authWithCustomToken(this.data.auth_token,function(error){if(error){console.error(error.code,error.message);$('#FBC_connect').removeClass('button-disabled');$('#FBC_notify').hide().html(error.message).fadeIn(200);self.display_ntf(self.strings.msg.conn_err,'error')}else{$('#FBC_notify').html(self.strings.msg.you_offline);$('#FBC_connect').html(self.strings.msg.connect).data('logged',0).removeClass('button-disabled');self.data.logged=!0;self.data.ref_users.once('value',function(snap){var users=snap.val(),i=0;if(users!==null){var total_user=Object.keys(users).length;$.each(users,function(user_id,user){i++;if(user){if(user.user_type=='operator'&&user.status==='online'){self.data.online_ops[user.user_id]=user}}
if(i===total_user){self.data.mode='offline';self.check_user(self.opts.user_info.user_id)}})}else{self.data.mode='offline';self.check_user(self.opts.user_info.user_id)}
if(callback)
callback()})}})},logged_in:function(user){var self=this;self.trigger_premium('play_sound','connected');self.listen_msgs();$('#FBC_notify').hide().empty();$('#FBC_connect').html('<i class="fa fa-check-circle" style="color:#acc327;"></i> '+self.strings.msg.online_btn).data('logged',1).data('status','online').removeClass('button-disabled');self.purge_firebase()},logout:function(end_chat){var self=this;if(this.data.user.user_id){self.data.ref_user.off();self.data.ref_users.off();self.data.ref_msgs.off();self.trigger_premium('play_sound','offline');$('#FBC_notify').html(self.strings.msg.you_offline);$('#FBC_connect').html(self.strings.msg.connect).data('logged',0).data('status','offline').removeClass('button-disabled');self.show_welcome_popup()}
$(window).trigger('resize');self.offline()},be_offline:function(){this.data.mode='offline';if(this.data.ref_user){this.data.ref_user.child('status').set('offline');this.data.ref_user.child('last_online').set(Firebase.ServerValue.TIMESTAMP)}
this.offline()},offline:function(){var self=this;self.trigger_premium('play_sound','disconnected');$('#FBC_notify').html(self.strings.msg.you_offline);$('#FBC_connect').html('<i class="fa fa-check-circle" style="color:#e54045;"></i> '+self.strings.msg.offline_btn).data('logged',0).data('status','offline').removeClass('button-disabled')},check_user:function(user_id){var self=this;this.data.ref_user=this.data.ref_users.child(user_id);this.data.ref_user.once('value',function(snap){var user_data=snap.val();if(!user_data)
user_data={};self.get_user(user_id,user_data)});this.data.ref_user.child('chat_with').on('value',function(snap){var value=snap.val();if(value!=null){self.data.user.chat_with=value}});this.data.ref_users.on('child_removed',function(snap){var user=snap.val();if(!user){return}
if(user_id===user.user_id){self.logout()}})},get_user:function(user_id,user_data,callback){var self=this;if(user_data.user_id){this.data.user=user_data;this.data.ref_user.child('status').set('offline');this.data.ref_user.child('user_ip').set(this.opts.user_info.user_ip);this.data.ref_user.child('current_page').set(this.opts.user_info.current_page);this.data.ref_user.child('user_name').set(this.opts.user_info.user_name);this.data.ref_user.child('user_email').set(this.opts.user_info.user_email);this.data.ref_user.child('gravatar').set(this.opts.user_info.gravatar);this.data.ref_user.child('avatar_type').set(this.opts.user_info.avatar_type);this.data.ref_user.child('avatar_image').set(this.opts.user_info.avatar_image);this.data.ref_user.child('vendor_id').set(fbc.active_vendor.vendor_id);this.data.ref_user.child('vendor_name').set(fbc.active_vendor.vendor_name);this.data.mode='offline';this.manage_connections();this.logged_in(this.data.user);this.listen_users();if(callback)
callback()}else if(this.data._new_user===!0){var cnv=this.data.ref_cnv.push({user_id:user_id,created_at:Firebase.ServerValue.TIMESTAMP,accepted_at:'',evaluation:'',user_type:'operator',receive_copy:!1}),data={user_id:user_id,conversation_id:cnv.key(),last_online:'',is_mobile:this.data.is_mobile,chat_with:'free',status:'online',vendor_id:fbc.active_vendor.vendor_id,vendor_name:fbc.active_vendor.vendor_name};for(var i in this.opts.user_info){data[i]=this.opts.user_info[i]}
this.data.user=data;this.data.ref_user.set(data,function(error){if(!error){self.data.mode='online';self.logged_in(self.data.user);self.manage_connections();self.listen_users()}
if(callback)
callback()})}else{this.listen_users()}},listen_users:function(){var self=this;this.data.last_changed_id=null;$('#FBC_users > ul').remove();$('#FBC_users').append('<ul></ul>');this.data.user_list=$('#FBC_users > ul');this.data.ref_users.once('value',function(snap){var users=snap.val(),i=0;if(users!==null){var total_user=Object.keys(users).length;self.data.online_ops={};$.each(users,function(user_id,user){i=i+1;if(user){if(self.valid_operator(user.vendor_id)){if(user.user_type==='operator'){if(user.status==='online'){self.data.online_ops[user.user_id]=user}else{delete self.data.online_ops[user.user_id]}}
self.add_user_item(user)}}
if(i===total_user){self.data.ref_users.on('value',function(snap){$('#FBC_users > ul').empty();var users=snap.val();$.each(users,function(user_id,user){if(self.valid_operator(user.vendor_id)){self.update_user(user)}})})}})}})},update_user:function(user,prev_id){if(user){if(!user.user_id){return}}
if(user){if(user.conversation_id){this.add_user_item(user);if(user.user_type==='operator'){if(user.status==='online'){this.data.online_ops[user.user_id]=user}else{delete this.data.online_ops[user.user_id]}}
if(!prev_id)
if($.inArray(user.user_id,this.objs.checked_user_ids)==-1&&user.user_id!=this.data.user.user_id){this.trigger_premium('play_sound','online');if(user.user_type!='operator')
this.notify(this.strings.msg.new_user_online,user.user_name+' ('+user.user_type+')',null,'user_online');this.objs.checked_user_ids.push(user.user_id)}
if(this.data.active_user_id===user.user_id)
$('#FBC_active_page').attr('href',user.current_page).find('span').html(user.current_page)}else{this.clean_user_data(user.user_id)}}
this.data.last_changed_id=prev_id},clean_user_data:function(user_id){var self=this,ref_user=this.data.ref_users.child(user_id);ref_user.once('value',function(snap){var user=snap.val();ref_user.remove();if(user.conversation_id){self.ref_cnv.child(user.conversation_id)}
self.data.ref_msgs.once('value',function(msg_snap){var msgs=msg_snap.val();if(msgs){$.each(msgs,function(msg_id,msg){if(msg.user_id===user_id){self.data.ref_msgs.child(msg_id).remove()}})}})})},add_user_item:function(user){if(!user.user_id||!this.data.user_list)
return;var username='',is_busy=!1,elem_id='#FBC_chat_user_'+user.user_id;if(user.chat_with!='free'){if(this.data.online_ops[user.chat_with]==null){this.data.ref_users.child(user.user_id).child('chat_with').set('free');is_busy=!1}else{is_busy=(user.chat_with!=this.data.user.user_id);username=this.data.online_ops[user.chat_with].user_name}}
var user_status=(is_busy)?' busy':' free';var last_online=(user.status==='offline'||user.status==='wait')?' - <span class="other-info" data-time="'+user.last_online+'">'+this.timeago(user.last_online)+'</span>':'',user_info=(is_busy)?'<br /><span class="other-info">'+this.strings.msg.talking_label.replace(/%s/i,username)+'</span>':'',vendor='';if(user.user_type=='operator'){user_status=' op'}
if(fbc.wcfm_wpv_active&&fbc.active_vendor.vendor_id=='0'){vendor=(user.vendor_id==0)?'':this.strings.msg.current_shop.replace(/%s/i,user.vendor_name)+' '}
$(elem_id).remove();var user_name=(user.user_name||user.user_email||'N/A'),cssclass='user-'+user.status+' user-'+user.user_type+user_status,avatar=this.set_avatar(user.user_type,{gravatar:user.gravatar,avatar_type:user.avatar_type,avatar_image:user.avatar_image}),is_mobile=((user.is_mobile)?'<i class="fa fa-mobile"></i>':''),user_meta=vendor+user.user_type+last_online+user_info;this.data.user_list.append('<li id="FBC_chat_user_'+user.user_id+'" data-id="'+user.user_id+'" data-cnv-id="'+user.conversation_id+'" data-name="'+user_name+'" data-count="0" data-chat="'+user.chat_with+'" class="'+cssclass+'">'+'<div class="user-avatar"><img src="'+avatar+'" /></div>'+'<i class="fa fa-check-circle"></i>'+is_mobile+'<div class="chat-username">'+user_name+'<span class="chat-count"></span></div>'+'<div class="chat-meta">'+user_meta+'</div></li>');var obj_user=$(elem_id);if(user.user_id==this.data.active_user_id){obj_user.addClass('chat-active').removeClass('new-msg').data('count',0).find('.chat-count').empty();if(this.objs.new_msgs_count[user.user_id]!=null)
this.objs.new_msgs_count[user.user_id]=0}else{var msg_count=(this.objs.new_msgs_count[user.user_id]!=null)?this.objs.new_msgs_count[user.user_id]:0;if(msg_count>0)
obj_user.data('count',msg_count).find('.chat-count').html('('+msg_count+')')}
$(window).trigger('resize')},notify:function(title,msg,callback,tag){if(!Notification)
return;if(!("Notification" in window)){return}else if(Notification.permission==="granted"){var notification=new Notification(title,{body:msg,icon:fbc.plugin_url+'/images/fbc-ico.png',tag:tag});if(callback)
notification.onclick=function(){callback()};else notification.close();setTimeout(function(){notification.close()},4000)}else if(Notification.permission!=='denied'){Notification.requestPermission(function(permission){if(!('permission' in Notification)){Notification.permission=permission}
if(permission==="granted"){var notification=new Notification(title,{body:msg});if(callback)
notification.onclick=function(){callback()};else notification.close();setTimeout(function(){notification.close()},4000)}})}},set_avatar:function(user_type,user_data){user_type=(user_type=='operator')?'admin':'user';if(fbc.is_premium){return this.trigger_premium('set_avatar_premium',user_type,user_data)}else{return this.data.assets_url+'/images/default-avatar-'+user_type+'.png'}},time:function(t,n){return this.strings.time[t]&&this.strings.time[t].replace(/%d/i,Math.abs(Math.round(n)))},timeago:function(time){if(!time)
return'';var now=new Date(),seconds=((now.getTime()-time)*0.001)>>0,minutes=seconds/60,hours=minutes/60,days=hours/24,years=days/365;return(seconds<45&&this.time('seconds',seconds)||seconds<90&&this.time('minute',1)||minutes<45&&this.time('minutes',minutes)||minutes<90&&this.time('hour',1)||hours<24&&this.time('hours',hours)||hours<42&&this.time('day',1)||days<30&&this.time('days',days)||days<45&&this.time('month',1)||days<365&&this.time('months',days/30)||years<1.5&&this.time('year',1)||this.time('years',years))+' '+this.strings.time.suffix},listen_msgs:function(){var self=this;this.data.ref_msgs.off();this.data.ref_msgs.once('value',function(snap){var msgs=snap.val(),total_msgs=msgs?Object.keys(msgs).length:0,i=1;if(msgs){$.each(msgs,function(msg_id,msg){msg.first_load=!0;self.new_msg(msg);if(total_msgs==i){self.listen_new_msgs(msg_id)}
i=i+1})}else{self.listen_new_msgs()}})},new_msg:function(msg,msg_id){var self=this;if(self.valid_operator(msg.vendor_id)){var obj_user=$('#FBC_chat_user_'+msg.user_id),obj_count=obj_user.find('.chat-count'),total_msg=parseInt(obj_user.data('count'));if(msg.read==!1&&msg.user_id!=self.data.user.user_id&&!msg_id){total_msg=total_msg+1;self.objs.new_msgs_count[msg.user_id]=total_msg;obj_user.addClass('new-msg').data('count',total_msg);obj_count.html('('+total_msg+')');self.trigger_premium('play_sound','new-msg');self.notify(self.strings.msg.new_msg,msg.user_name+': '+msg.msg,null,'new_msg')}
if(self.data.user.conversation_id==msg.conversation_id){$('#FBC_load_msg').remove();self.add_msg(msg,self.objs.last_user_id,self.objs.last_msg_id);self.objs.last_user_id=msg.user_id;if(self.objs.last_user_id!=msg.user_id||!self.objs.last_msg_id)
self.objs.last_msg_id=msg.msg_id}
if(msg_id){self.data.ref_msgs.child(msg_id).child('read').set(!0)}}},listen_new_msgs:function(msg_id){var self=this,ref_msgs=!msg_id?self.data.ref_msgs:self.data.ref_msgs.startAt(null,msg_id),first=!0;if(!msg_id)
first=!1;ref_msgs.on('child_added',function(new_snap){var new_msg=new_snap.val();new_msg.id=new_snap.key();self.new_msg(new_msg);first=!1})},add_msg:function(msg,last_user_id,last_msg_id){var now=new Date(),d=new Date(msg.msg_time),t=d.getHours()+':'+(d.getMinutes()<10?'0':'')+d.getMinutes(),msg_content=this.sanitize_msg(msg.msg),msg_time=(d.toDateString()==now.toDateString())?t:d.getUTCDate()+' '+this.strings.months_short[d.getUTCMonth()]+', '+t;if(this.objs.cnv){var cssclass=((msg.user_id==this.data.user.user_id)?' chat-you':''),msg_date=d.getUTCDate()+' '+this.strings.months[d.getUTCMonth()]+' '+d.getUTCFullYear()+' '+t,avatar=this.set_avatar(msg.user_type,{gravatar:msg.gravatar,avatar_type:msg.avatar_type,avatar_image:msg.avatar_image});this.objs.cnv.append('<div id="FBC_msg_'+msg.id+'" class="chat-cnv-line'+cssclass+'">'+'<div title="'+msg_date+'" class="chat-cnv-time">'+msg_time+'</div>'+'<div class="chat-avatar"><img src="'+avatar+'" /></div> '+'<div class="chat-cnv-msg">'+'<div class="chat-cnv-author">'+msg.user_name+'</div>'+msg_content+'</div> '+'</div>'+'<div class="chat-clear"></div>').scrollTop(this.objs.cnv.prop('scrollHeight'))}},sanitize_msg:function(str){var msg,pattern_url,pattern_pseudo_url,pattern_email,pattern_html,pattern_line;var tagsToReplace={'&':'&amp;','<':'&lt;','>':'&gt;'};msg=str.replace(/[&<>]/g,function(i){return tagsToReplace[i]||i});pattern_line=/\n/gim;msg=msg.replace(pattern_line,'<br />');pattern_url=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;msg=msg.replace(pattern_url,'<a href="$1" target="_blank">$1</a>');pattern_pseudo_url=/(^|[^\/])(www\.[\S]+(\b|$))/gim;msg=msg.replace(pattern_pseudo_url,'$1<a href="http://$2" target="_blank">$2</a>');pattern_email=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;msg=msg.replace(pattern_email,'<a href="mailto:$1">$1</a>');return msg},manage_reply_box:function(last_cnv_id){var self=this,writing=!1,obj_reply=$('#FBC_cnv_reply'),fn_delay=(function(){var timer=0;return function(callback,ms){clearTimeout(timer);timer=setTimeout(callback,ms)}})();this.data.ref_cnv.child(this.data.user.conversation_id+'/typing').remove();obj_reply.keydown(function(e){if(e.keyCode===13&&!e.shiftKey){e.preventDefault();var msg=$(this).val();if(msg){$(this).val('').trigger('autosize.resize');self.push_msg(msg);self.data.ref_cnv.child(self.data.user.conversation_id+'/typing/'+self.data.user.user_id).remove()}}else{if(!writing){switch(e.keyCode){case 17:case 18:case 16:case 9:case 8:case 224:case 17:case 91:case 93:return}
self.data.ref_cnv.child(self.data.user.conversation_id+'/typing/'+self.data.user.user_id).set(self.data.user.user_name);writing=!0}
fn_delay(function(){self.data.ref_cnv.child(self.data.user.conversation_id+'/typing/'+self.data.user.user_id).remove();writing=!1},1300)}});if(last_cnv_id){this.data.ref_cnv.child(last_cnv_id+'/typing').off();this.data.ref_cnv.child(last_cnv_id).off('child_added')}
this.data.ref_cnv.child(this.data.user.conversation_id+'/typing').on('value',function(snap){var i=0,users=snap.val(),total_users=(users)?Object.keys(users).length:0;if(!users){self.clean_ntf();return}
$.each(users,function(user_id,user_name){if(user_id!=null&&user_id!=self.data.user.user_id){self.display_ntf(self.strings.msg.writing.replace(/%s/i,user_name),'typing');return}
if(total_users===i){self.clean_ntf()}
i=i+1})});this.data.ref_cnv.child(this.data.user.conversation_id).on('child_added',function(new_snap){if(new_snap.val()=='closed'){$('#FBC_cnv_reply').attr('disabled','disabled');$('.chat-cnv-input').addClass('chat-disabled')}})},reload_cnv:function(cnv_id){var self=this;this.data.ref_msgs.once('value',function(snap){var now=new Date(),all_msgs=snap.val(),total_msgs=all_msgs?Object.keys(all_msgs).length:0,total_user_msgs=0,i=1;if(all_msgs){$.each(all_msgs,function(msg_id,msg){if(msg.conversation_id==cnv_id){self.new_msg(msg,msg_id);total_user_msgs=total_user_msgs+1}
if(total_msgs==i){self.cnv_msgs_loaded(total_user_msgs)}
i=i+1})}else{self.cnv_msgs_loaded(0)}})},cnv_msgs_loaded:function(total_msgs){if(!total_msgs)
$('#FBC_load_msg').html(this.strings.msg.no_msg+'.');else $('#FBC_load_msg').empty()},push_msg:function(msg){this.data.ref_msgs.push({user_id:this.data.user.user_id,user_type:this.data.user.user_type,conversation_id:this.data.user.conversation_id,user_name:this.data.user.user_name||this.data.user.user_email,gravatar:this.data.user.gravatar,avatar_type:this.data.user.avatar_type,avatar_image:this.data.user.avatar_image,msg:msg,msg_time:Firebase.ServerValue.TIMESTAMP,vendor_id:fbc.active_vendor.vendor_id,read:!0})},get_user_data:function(user_id,callback){this.data.ref_users.child(user_id).once('value',function(snap){var user=snap.val();callback(user)})},manage_connections:function(){var self=this;if(!this.data.ref_user){return}
this.data.ref_conn.on('value',function(snap){if(snap.val()===!0){$('#FBC_firebase_offline').hide();var conn=self.data.ref_user.child('connections').push(!0);conn.onDisconnect().remove();self.data.ref_user.child('status').set('online');self.data.ref_user.child('status').onDisconnect().set('offline');self.data.ref_user.child('last_online').onDisconnect().set(Firebase.ServerValue.TIMESTAMP);self.data.ref_cnv.child(self.data.user.conversation_id+'/typing/'+self.data.user.user_id).onDisconnect().remove()}else{$('#FBC_firebase_offline').show()}})},post:function(action,mode,data,callback){var self=this;$.post(fbc.ajax_url+'?action='+action+'&mode='+mode,data,callback,'json').fail(function(jqXHR){console.log(mode,': ',jqXHR);return!1})},trigger_premium:function(event,p1,p2,p3,p4,p5,p6){if(!fbc.is_premium){return}
return this.premium[event].call(this,p1,p2,p3,p4,p5,p6)},check_ntf:function(){if(!("Notification" in window)){return}else if(Notification.permission!=='denied'){Notification.requestPermission(function(permission){if(!('permission' in Notification)){Notification.permission=permission}})}},display_ntf:function(ntf,type){var icon;switch(type){case 'success':icon='<i class="fa fa-check"></i> ';break;case 'error':icon='<i class="fa fa-exclamation-triangle"></i> ';break;case 'typing':icon='<i class="fa fa-pencil-square-o"></i> ';break;default:icon=''}
$('#FBC_popup_ntf').removeClass().addClass('chat-ntf chat-'+type).html(icon+ntf).fadeIn(300)},clean_ntf:function(){$('#FBC_popup_ntf').html('').hide()},clear_user_data:function(cnv_id,callback){var self=this;this.data.ref_cnv.child(cnv_id).once('value',function(snap_cnv){var cnv=snap_cnv.val();if(!cnv)
return;var user_id=cnv.user_id;self.data.ref_msgs.once('value',function(snap_msgs){var msgs=snap_msgs.val(),total_msgs=msgs?Object.keys(msgs).length:0,i=0;if(msgs){$.each(msgs,function(msg_id,msg){i=i+1;if(msg.conversation_id===cnv_id){self.data.ref_msgs.child(msg_id).remove()}
if(total_msgs===i){if(callback)
callback()}})}else if(callback){callback()}
self.data.ref_users.child(user_id).remove();self.data.ref_cnv.child(cnv_id).remove()})})},total_online_ops:function(){if(this.data.online_ops){return Object.keys(this.data.online_ops).length}else{return 0}},purge_firebase:function(force_purge){var self=this;this.data.ref_users.once('value',function(snap){var users=snap.val(),i=0,del_list=[],cnv_list=[],op_cnv_list=[],interval=(force_purge)?0:3600;if(users!==null){var total_user=Object.keys(users).length,now=new Date();$.each(users,function(user_id,user){i++;if(user){if(user.status==='offline'){var seconds=((now.getTime()-user.last_online)*0.001)>>0;if(seconds>=interval){if(user.user_type!='operator'){if(user.conversation_id!=null){cnv_list.push(user.conversation_id)}else{del_list.push(user_id)}}else{del_list.push(user_id);op_cnv_list.push(user.conversation_id)}}}else if(user.status==='wait'){if(user.last_online===undefined){del_list.push(user_id)}else{var seconds=((now.getTime()-user.last_online)*0.001)>>0;if(seconds>=(interval*2)){del_list.push(user_id)}}}}
if(i===total_user){$.each(del_list,function(index,user_id){self.data.ref_users.child(user_id).remove()});$.each(op_cnv_list,function(index,cnv_id){self.data.ref_cnv.child(cnv_id).remove()});$.each(cnv_list,function(index,cnv_id){if(fbc.is_premium){self.trigger_premium('save_user_data',cnv_id,!0,now.getTime())}else{self.clear_user_data(cnv_id)}})}})}})},show_welcome_popup:function(){$('#FBC_popup_cnv').addClass('chat-welcome');$('#FBC_cnv').hide();$('#FBC_cnv_bottom').hide();$('#FBC_sidebar_right').hide()},valid_operator:function(vendor_id){if(!fbc.wcfm_wpv_active){return!0}
if(fbc.wcfm_wpv_active&&fbc.active_vendor.vendor_id==vendor_id){return!0}
if(fbc.wcfm_wpv_active&&fbc.active_vendor.vendor_id=='0'&&!fbc.vendor_only_chat){return!0}
return!1}};$.fn[FBC_console]=function(){var instance;if(!(this.data(data_plugin)instanceof Plugin)){this.data(data_plugin,new Plugin(this))}
instance=this.data(data_plugin);instance.el=this;instance.init()};$(document).ready(function(){$('#FBC_console').fbc_console();$(window).resize(function(){var win_h=window.innerHeight,win_w=$(window).width(),adminbar_h=$('#wpadminbar').length>0?$('#wpadminbar').height():0,console_h=win_h-adminbar_h-40,console_w=$('#wpbody-content').width()||$('.wcfm-wcfm-content').width();if($('#wpbody-content').length==0){console_h=window.innerHeight-(adminbar_h+$('#wcfm_wcfm-header').outerHeight()+30)}
if(win_w<766){$('#FBC_console').css('height','');$('#FBC_sidebar_left').css('height','');$('#FBC_popup_cnv').css('height','');$('#FBC_sidebar_right').css('height','');$('#FBC_users').css('height','');$('#FBC_cnv').css('height',250);$('.wcfm-live-chat-console-container').width(console_w-12)}else{$('#FBC_console').height(console_h);$('#FBC_sidebar_left').height(console_h);$('#FBC_popup_cnv').height(console_h);$('#FBC_sidebar_right').height(console_h);$('#FBC_users').height(console_h-110);$('#FBC_cnv').height(console_h-$('#FBC_cnv_bottom').innerHeight()-30);$('.wcfm-live-chat-console-container').width(console_w-20)}}).trigger('resize');$(window).scroll(function(){if($('#wpbody-content').length==0){var adminbar_h=0,console_h=0,console_top=15;if($('#wpadminbar').length>0){adminbar_h=$('#wpadminbar').height();console_top=15+adminbar_h}
var scroll=$(window).scrollTop();if(scroll<=$('#wcfm_wcfm-header').outerHeight()){console_h=window.innerHeight-(adminbar_h+30)+scroll}else{console_h=window.innerHeight-(adminbar_h+$('#wcfm_wcfm-header').outerHeight()+30)}}})})}(jQuery,window,document))